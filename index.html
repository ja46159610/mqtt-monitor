<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>水質監控儀表板 v0.14</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #eef2f7;
      color: #333;
      padding: 2em;
      max-width: 700px;
      margin: auto;
    }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 1em; }
    #status, #login-status, #timing-log {
      text-align: center;
      margin-bottom: 1em;
      font-weight: 600;
    }
    .error { color: #e74c3c; }
    .connected { color: #27ae60; }

    .container { display: none; gap: 1em; }
    .tabs {
      display: flex;
      flex-direction: column;
      width: 140px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      padding: 0.5em;
    }
    .tab {
      padding: 0.75em 1em;
      background: #bdc9d9;
      color: #2c3e50;
      cursor: pointer;
      font-weight: 600;
      border-radius: 6px;
      margin-bottom: 0.5em;
      text-align: center;
      user-select: none;
      transition: background 0.3s;
    }
    .tab.active {
      background: #2980b9;
      color: white;
      box-shadow: 0 3px 8px rgb(41 128 185 / 0.6);
    }
    .content-box {
      flex-grow: 1;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      padding: 2em 1.5em;
      min-height: 150px;
    }
    .content-box:hover {
      box-shadow: 0 4px 15px rgb(0 0 0 / 0.15);
    }
    h2 { margin-top: 0; color: #2980b9; }
    .ph-value {
      font-size: 4rem;
      font-weight: 700;
      color: #27ae60;
      margin-top: 0.3em;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>水質即時監控儀表板 v0.14</h1>

  <!-- 登入區 -->
  <div id="login-box" style="text-align:center;">
    <input type="text" id="username" placeholder="帳號" style="padding:0.5em; margin:0.5em;">
    <input type="password" id="password" placeholder="密碼" style="padding:0.5em; margin:0.5em;">
    <button onclick="submitLogin()">登入</button>
    <button onclick="logout()">登出</button>
    <div id="login-status"></div>
  </div>

  <div id="status">請先登入以查看資料</div>
  <div id="timing-log" style="font-size: 0.95em;"></div>

  <!-- 主頁面 -->
  <div class="container">
    <div class="tabs">
      <div class="tab active" data-target="control">溫泉會館_A</div>
      <div class="tab" data-target="a">溫泉會館_B</div>
    </div>

    <div id="control" class="content-box">
      <h2>湯池_1 水質 pH</h2>
      <div id="ph_control" class="ph-value">尚無數據</div>
    </div>

    <div id="a" class="content-box" style="display:none;">
      <h2>湯池_2 水質 pH</h2>
      <div id="ph_a" class="ph-value">尚無數據</div>
    </div>
  </div>

  <script>
    let client = null;
    let t_start = 0;
    let timingLog = "";

    const tabs = document.querySelectorAll('.tab');
    const contents = {
      control: document.getElementById('control'),
      a: document.getElementById('a')
    };

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.dataset.target;
        for (const key in contents) {
          contents[key].style.display = (key === target) ? 'block' : 'none';
        }
      });
    });

    function logTiming(msg) {
      const now = (performance.now() - t_start).toFixed(0);
      timingLog += `⏱️ ${msg}（${now} ms）<br>`;
      document.getElementById("timing-log").innerHTML = timingLog;
    }

    function submitLogin() {
      const user = document.getElementById("username").value;
      const pwd = document.getElementById("password").value;

      if (!user || !pwd) {
        document.getElementById("login-status").textContent = "請輸入帳號與密碼";
        document.getElementById("login-status").style.color = "red";
        return;
      }

      const formData = new URLSearchParams();
      formData.append("User", user);
      formData.append("Pwd", pwd);

      fetch("http://localhost:8000/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData
      })
        .then(res => {
          if (!res.ok) throw new Error("帳號或密碼錯誤");
          return res.json();
        })
        .then(data => {
          alert("登入成功，允許主題：" + data.topics);
          document.getElementById("login-status").textContent = "✅ 登入成功";
          document.getElementById("login-status").style.color = "green";

          // 顯示主頁內容
          document.querySelector(".container").style.display = "flex";
          document.getElementById("status").textContent = "連線中...";
          document.getElementById("status").className = "";
          document.getElementById("timing-log").textContent = "";
          timingLog = "";

          // 清空上一次的 client
          if (client) {
            client.end();
            client = null;
          }

          // 開始計時
          t_start = performance.now();
          logTiming("開始建立 MQTT 連線");

          // 建立 MQTT 客戶端
          client = mqtt.connect("wss://control.cittw.store:443", {
            username: user,
            password: pwd,
            reconnectPeriod: 2000
          });

          client.on("connect", () => {
            logTiming("✅ 已連線到 MQTT Broker");
            document.getElementById("status").textContent = "✅ 已連線至 MQTT Broker";
            document.getElementById("status").className = "connected";

            // 訂閱使用者允許的 topics
            const topics = data.topics.split(",");
            topics.forEach(topic => {
              client.subscribe(topic.trim());
              logTiming("📡 已訂閱: " + topic.trim());
            });
          });

          client.on("message", (topic, message) => {
            logTiming("📥 收到資料：" + topic);
            try {
              const msg = JSON.parse(message.toString());
              const ph = msg.ph;
              if (topic === "sensor/control/ph") {
                document.getElementById("ph_control").textContent = `pH 值：${ph.toFixed(2)}`;
              } else if (topic === "sensor/A/ph") {
                document.getElementById("ph_a").textContent = `pH 值：${ph.toFixed(2)}`;
              }
            } catch (e) {
              console.error("解析錯誤", e);
            }
          });

          client.on("error", err => {
            document.getElementById("status").textContent = "❌ 連線錯誤：" + err.message;
            document.getElementById("status").className = "error";
          });

          client.on("offline", () => {
            document.getElementById("status").textContent = "⚠️ 已離線";
            document.getElementById("status").className = "error";
          });
        })
        .catch(err => {
          document.getElementById("login-status").textContent = "❌ 登入失敗：" + err.message;
          document.getElementById("login-status").style.color = "red";
        });
    }

    function logout() {
      if (client) {
        client.end();
        client = null;
      }

      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      document.getElementById("login-status").textContent = "已登出";
      document.getElementById("login-status").style.color = "gray";
      document.getElementById("status").textContent = "請先登入以查看資料";
      document.getElementById("status").className = "";
      document.getElementById("timing-log").textContent = "";
      document.querySelector(".container").style.display = "none";
    }
  </script>
</body>
</html>
