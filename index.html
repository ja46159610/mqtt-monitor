<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æ°´è³ªç›£æ§å„€è¡¨æ¿ v0.14</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #eef2f7;
      color: #333;
      padding: 2em;
      max-width: 700px;
      margin: auto;
    }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 1em; }
    #status, #login-status, #timing-log {
      text-align: center;
      margin-bottom: 1em;
      font-weight: 600;
    }
    .error { color: #e74c3c; }
    .connected { color: #27ae60; }

    .container { display: none; gap: 1em; }
    .tabs {
      display: flex;
      flex-direction: column;
      width: 140px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      padding: 0.5em;
    }
    .tab {
      padding: 0.75em 1em;
      background: #bdc9d9;
      color: #2c3e50;
      cursor: pointer;
      font-weight: 600;
      border-radius: 6px;
      margin-bottom: 0.5em;
      text-align: center;
      user-select: none;
      transition: background 0.3s;
    }
    .tab.active {
      background: #2980b9;
      color: white;
      box-shadow: 0 3px 8px rgb(41 128 185 / 0.6);
    }
    .content-box {
      flex-grow: 1;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      padding: 2em 1.5em;
      min-height: 150px;
    }
    .content-box:hover {
      box-shadow: 0 4px 15px rgb(0 0 0 / 0.15);
    }
    h2 { margin-top: 0; color: #2980b9; }
    .ph-value {
      font-size: 4rem;
      font-weight: 700;
      color: #27ae60;
      margin-top: 0.3em;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>æ°´è³ªå³æ™‚ç›£æ§å„€è¡¨æ¿ v0.14</h1>

  <!-- ç™»å…¥å€ -->
  <div id="login-box" style="text-align:center;">
    <input type="text" id="username" placeholder="å¸³è™Ÿ" style="padding:0.5em; margin:0.5em;">
    <input type="password" id="password" placeholder="å¯†ç¢¼" style="padding:0.5em; margin:0.5em;">
    <button onclick="submitLogin()">ç™»å…¥</button>
    <button onclick="logout()">ç™»å‡º</button>
    <div id="login-status"></div>
  </div>

  <div id="status">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹è³‡æ–™</div>
  <div id="timing-log" style="font-size: 0.95em;"></div>

  <!-- ä¸»é é¢ -->
  <div class="container">
    <div class="tabs">
      <div class="tab active" data-target="control">æº«æ³‰æœƒé¤¨_A</div>
      <div class="tab" data-target="a">æº«æ³‰æœƒé¤¨_B</div>
    </div>

    <div id="control" class="content-box">
      <h2>æ¹¯æ± _1 æ°´è³ª pH</h2>
      <div id="ph_control" class="ph-value">å°šç„¡æ•¸æ“š</div>
    </div>

    <div id="a" class="content-box" style="display:none;">
      <h2>æ¹¯æ± _2 æ°´è³ª pH</h2>
      <div id="ph_a" class="ph-value">å°šç„¡æ•¸æ“š</div>
    </div>
  </div>

  <script>
    let client = null;
    let t_start = 0;
    let timingLog = "";

    const tabs = document.querySelectorAll('.tab');
    const contents = {
      control: document.getElementById('control'),
      a: document.getElementById('a')
    };

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.dataset.target;
        for (const key in contents) {
          contents[key].style.display = (key === target) ? 'block' : 'none';
        }
      });
    });

    function logTiming(msg) {
      const now = (performance.now() - t_start).toFixed(0);
      timingLog += `â±ï¸ ${msg}ï¼ˆ${now} msï¼‰<br>`;
      document.getElementById("timing-log").innerHTML = timingLog;
    }

    function submitLogin() {
      const user = document.getElementById("username").value;
      const pwd = document.getElementById("password").value;

      if (!user || !pwd) {
        document.getElementById("login-status").textContent = "è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼";
        document.getElementById("login-status").style.color = "red";
        return;
      }

      const formData = new URLSearchParams();
      formData.append("User", user);
      formData.append("Pwd", pwd);

      fetch("http://localhost:8000/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData
      })
        .then(res => {
          if (!res.ok) throw new Error("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
          return res.json();
        })
        .then(data => {
          alert("ç™»å…¥æˆåŠŸï¼Œå…è¨±ä¸»é¡Œï¼š" + data.topics);
          document.getElementById("login-status").textContent = "âœ… ç™»å…¥æˆåŠŸ";
          document.getElementById("login-status").style.color = "green";

          // é¡¯ç¤ºä¸»é å…§å®¹
          document.querySelector(".container").style.display = "flex";
          document.getElementById("status").textContent = "é€£ç·šä¸­...";
          document.getElementById("status").className = "";
          document.getElementById("timing-log").textContent = "";
          timingLog = "";

          // æ¸…ç©ºä¸Šä¸€æ¬¡çš„ client
          if (client) {
            client.end();
            client = null;
          }

          // é–‹å§‹è¨ˆæ™‚
          t_start = performance.now();
          logTiming("é–‹å§‹å»ºç«‹ MQTT é€£ç·š");

          // å»ºç«‹ MQTT å®¢æˆ¶ç«¯
          client = mqtt.connect("wss://control.cittw.store:443", {
            username: user,
            password: pwd,
            reconnectPeriod: 2000
          });

          client.on("connect", () => {
            logTiming("âœ… å·²é€£ç·šåˆ° MQTT Broker");
            document.getElementById("status").textContent = "âœ… å·²é€£ç·šè‡³ MQTT Broker";
            document.getElementById("status").className = "connected";

            // è¨‚é–±ä½¿ç”¨è€…å…è¨±çš„ topics
            const topics = data.topics.split(",");
            topics.forEach(topic => {
              client.subscribe(topic.trim());
              logTiming("ğŸ“¡ å·²è¨‚é–±: " + topic.trim());
            });
          });

          client.on("message", (topic, message) => {
            logTiming("ğŸ“¥ æ”¶åˆ°è³‡æ–™ï¼š" + topic);
            try {
              const msg = JSON.parse(message.toString());
              const ph = msg.ph;
              if (topic === "sensor/control/ph") {
                document.getElementById("ph_control").textContent = `pH å€¼ï¼š${ph.toFixed(2)}`;
              } else if (topic === "sensor/A/ph") {
                document.getElementById("ph_a").textContent = `pH å€¼ï¼š${ph.toFixed(2)}`;
              }
            } catch (e) {
              console.error("è§£æéŒ¯èª¤", e);
            }
          });

          client.on("error", err => {
            document.getElementById("status").textContent = "âŒ é€£ç·šéŒ¯èª¤ï¼š" + err.message;
            document.getElementById("status").className = "error";
          });

          client.on("offline", () => {
            document.getElementById("status").textContent = "âš ï¸ å·²é›¢ç·š";
            document.getElementById("status").className = "error";
          });
        })
        .catch(err => {
          document.getElementById("login-status").textContent = "âŒ ç™»å…¥å¤±æ•—ï¼š" + err.message;
          document.getElementById("login-status").style.color = "red";
        });
    }

    function logout() {
      if (client) {
        client.end();
        client = null;
      }

      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      document.getElementById("login-status").textContent = "å·²ç™»å‡º";
      document.getElementById("login-status").style.color = "gray";
      document.getElementById("status").textContent = "è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹è³‡æ–™";
      document.getElementById("status").className = "";
      document.getElementById("timing-log").textContent = "";
      document.querySelector(".container").style.display = "none";
    }
  </script>
</body>
</html>
